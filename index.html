<html>
  <head>
    <script
      type="module"
      src="https://unpkg.com/esp-web-tools@10/dist/web/install-button.js?module"
    ></script>

    <script>
      function get_versions(device) {
        const repo_name = device.replace(" ", "-");

        fetch(`https://api.github.com/repos/IoTLabs-pl/${repo_name}/releases`, {
          headers: {
            Accept: "application/vnd.github+json",
            "X-GitHub-Api-Version": "2022-11-28",
          },
        })
          .then((response) => response.json())
          .then((data) =>
            data
              .map((element) => ({
                manifest: element.assets.find((a) =>
                  a.name.includes("manifest")
                )?.browser_download_url,
                name: element.name || element.tag_name,
              }))
              .filter((v) => v.manifest && v.name)
          )
          .then((versions) => {
            const versionSelect = document.getElementById("version-select");

            while (versionSelect.firstChild) {
              versionSelect.firstChild.remove();
            }

            versions.forEach((v) => {
              const option = document.createElement("option");
              option.value = 'https://iotlabs-github-cors-proxy.deno.dev/' + v.manifest;
              option.textContent = v.name;
              versionSelect.appendChild(option);
            });

            set_manifest(versions[0]?.manifest);
          })
          .catch((error) => {
            console.error("Error fetching versions:", error);
            reject(error);
          });
      }

      function set_manifest(href) {
        const installButton = document.querySelector("esp-web-install-button");
        if (href) installButton.setAttribute("manifest", href);
        else installButton.removeAttribute("manifest");
      }

      window.onload = function () {
        const deviceSelect = document.getElementById("device-select");
        deviceSelect.addEventListener("change", function () {
          get_versions(this.value);
        });
        const versionSelect = document.getElementById("version-select");
        versionSelect.addEventListener("change", function () {
          set_manifest(this.value);
        });

        get_versions(deviceSelect.value);
      };
    </script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Jura:wght@300..700&display=swap");

      :root {
        --esp-tools-button-color: #2b4c5a;
      }
      esp-web-install-button::part(activate) {
        font-family: "Jura", sans-serif;
      }
      img#logo {
        max-width: 300px;
      }
      div#content {
        flex-grow: 1;
        font-family: "Jura", sans-serif;
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-self: center;
        align-items: center;
      }
      div#config > label {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 15px;
      }
      div#config > label:not(:last-child) {
        margin-bottom: 0;
      }
      body {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <img
      id="logo"
      src="https://iotlabs.pl/wp-content/uploads/2025/05/bitmap.png"
      alt="Logo"
    />
    <div id="content">
      <div id="config">
        <label>
          <div>Device</div>
          <select id="device-select">
            <option>wM-Bus Gateway</option>
          </select>
        </label>
        <label>
          <div>Version</div>
          <select
            id="version-select"
            onchange="set_manifest(this.value)"
          ></select>
        </label>
      </div>
      <esp-web-install-button> </esp-web-install-button>
    </div>
  </body>
</html>
